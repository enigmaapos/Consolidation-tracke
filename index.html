<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Binance Futures (Perp USDT) — EMA70/EMA200 Cross Scanner + Trade Setup</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1720;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#0ea5a4;
      --accent-dark:#042024;
      --glass-border: rgba(255,255,255,0.04);
      --green:#5eead4;
      --red:#fb7185;
      --radius:12px;
      --pad:12px;
      --shadow: 0 6px 18px rgba(2,6,23,0.6);
      --max-card-height: 60vh;
    }

    /* Reset-ish */
    html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, system-ui,-apple-system; background:var(--bg); color:#e6eef8; -webkit-font-smoothing:antialiased;}
    h1{margin:0 0 8px 0;font-size:18px;font-weight:600}
    .muted{color:var(--muted); font-size:13px}

    /* Page container */
    .wrap{padding:16px; max-width:1400px; margin:0 auto; box-sizing:border-box;}

    /* Controls */
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .controls .left { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls .right { margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    button{ padding:10px 14px; border:0; background:var(--accent); color:var(--accent-dark); border-radius:10px; cursor:pointer; font-weight:600; }
    button.secondary{ background:#334155; color:var(--muted); }
    input, select{ padding:8px 10px; border-radius:8px; border:1px solid #334155; background:var(--card); color:inherit; min-height:36px; box-sizing:border-box; }

    .chip{ padding:6px 10px; border-radius:999px; background:rgba(9,24,38,0.6); border:1px solid rgba(21,50,65,0.6); display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; }

    /* Cards grid */
    .grid{ display:grid; grid-template-columns: 1fr 760px; gap:12px; align-items:start; }
    @media (max-width:1100px){ .grid{ grid-template-columns: 1fr 420px; } }
    @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }

    /* Card styles */
    .card{ background:var(--card); border-radius:var(--radius); padding:12px; box-shadow:var(--shadow); border:1px solid var(--glass-border); box-sizing:border-box; }
    .card h2{ margin:0 0 8px 0; font-size:14px; color:var(--muted); font-weight:600 }
    .card .card-body{ display:block; }

    /* Tables */
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; vertical-align:middle; }
    th{ color:#9fb3c8; font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing:0.03em; }
    .green{ color:var(--green); }
    .red{ color:var(--red); }
    .small{ color:var(--muted); font-size:12px; }

    /* Scrollable table containers */
    .table-wrap{ max-height:var(--max-card-height); overflow:auto; padding-right:6px; -webkit-overflow-scrolling:touch; }
    .table-wrap table th:first-child, .table-wrap table td:first-child { min-width:110px; }

    /* Top table wider card style */
    .wide { max-width:100%; }

    /* Buttons & inputs responsive */
    @media (max-width:600px){
      button{ flex:1 1 auto; min-width:0; }
      .controls{ gap:6px; }
      .chip{ font-size:12px; padding:6px; }
      input, select{ font-size:13px; }
      th, td{ padding:8px 6px; font-size:12px; }
      h1{ font-size:16px; }
    }

    /* Minor helpers */
    .status{ margin-left:8px; font-size:13px; color:var(--muted); }
    .num{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; }
    .legend{ display:flex; gap:8px; align-items:center; margin-top:8px; color:var(--muted); font-size:12px; }
    .chip .checkbox{ transform:translateY(1px); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Binance Futures (Perp USDT) — EMA70/EMA200 Cross Scanner + Trade Setup</h1>

    <div class="controls">
      <div class="left">
        <button id="startPoll">Start Live Polling</button>
        <button id="stopPoll" class="secondary" disabled>Stop Polling</button>

        <label class="chip" title="Poll interval in seconds">
          Poll interval (s):
          <input id="pollInterval" type="number" min="5" value="10" style="width:72px; margin-left:6px;">
        </label>

        <label class="chip">
          Max symbols:
          <input id="maxAnalyze" type="number" min="1" value="20" style="width:72px; margin-left:6px;">
        </label>

        <label class="chip">
          Batch size:
          <input id="batchSize" type="number" min="1" value="5" style="width:60px; margin-left:6px;">
        </label>

        <label class="chip">
          Batch delay (ms):
          <input id="batchDelay" type="number" min="300" value="1200" style="width:80px; margin-left:6px;">
        </label>

        <button id="analyze" class="secondary">Analyze EMA Crosses</button>
      </div>

      <div class="right">
        <label class="chip">
          <input id="autoAnalyzeToggle" type="checkbox" class="checkbox" /> Auto-analyze
        </label>

        <label class="chip">
          <input id="soundToggle" type="checkbox" class="checkbox" /> Sound
        </label>

        <label class="chip">Stop ATR×
          <input id="stopAtrMult" type="number" step="0.1" min="0.1" value="0.8" style="width:64px; margin-left:6px;">
        </label>

        <label class="chip">TP1 ATR×
          <input id="tp1AtrMult" type="number" step="0.1" min="0.1" value="1.5" style="width:64px; margin-left:6px;">
        </label>

        <label class="chip">TP2 ATR×
          <input id="tp2AtrMult" type="number" step="0.1" min="0.1" value="3.0" style="width:64px; margin-left:6px;">
        </label>

        <label class="chip">Cross window:
          <input id="crossWindow" type="number" min="1" value="3" style="width:56px; margin-left:6px;" />
        </label>

        <div class="status" id="status">idle</div>
      </div>
    </div>

    <!-- grid with cards -->
    <div class="grid" id="grid">
      <!-- Left column: Pairs table card -->
      <div class="card">
        <h2>All USDT perpetual pairs</h2>
        <div class="muted" style="margin-bottom:8px;">(Blacklist applied). Table limited to first 500 for UI responsiveness.</div>
        <div class="table-wrap card-body" style="padding-top:6px;">
          <table id="pairsTable" role="table" aria-label="Filtered pairs">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Last</th>
                <th>24h %</th>
                <th>QuoteVol</th>
                <th>EMA Cross</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="legend">
          <div class="chip"><span class="green">●</span> Bull cross</div>
          <div class="chip"><span class="red">●</span> Bear cross</div>
          <div class="chip">Table scrolls if long</div>
        </div>
      </div>

      <!-- Right column: Top candidates card -->
      <div class="card wide">
        <h2>Top EMA cross candidates + trade setups</h2>
        <div class="muted" style="margin-bottom:8px;">Setups are ATR-based (14 × 15m ATR). Entry uses last close.</div>
        <div class="table-wrap card-body" style="padding-top:6px;">
          <table id="topTable" role="table" aria-label="Top EMA candidates">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Cross</th>
                <th>Dir</th>
                <th class="small">Entry</th>
                <th class="small">Stop</th>
                <th class="small">TP1</th>
                <th class="small">TP2</th>
                <th class="small">R:R1</th>
                <th class="small">R:R2</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:8px; color:var(--muted); font-size:13px;">
          Tips:
          <ul style="margin:6px 0 0 18px; padding:0;">
            <li>Click Start or Analyze once to unlock audio (required by browsers).</li>
            <li>Enable Auto-analyze carefully — it fetches many klines (keep Max symbols low).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ---------- (unchanged JS logic) ----------
  const TICKER_24H = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
  const KLINES = 'https://fapi.binance.com/fapi/v1/klines';
  const INTERVAL = '15m';
  const LOOKBACK_EMA200 = 240;
  const blacklist = [
    "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT","LINAUSDT",
    "LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT",
    "STMXUSDT","UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT",
    "BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT",
    "STRAXUSDT","COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT","MYROUSDT","1000XUSDT","DARUSDT"
  ];

  // UI refs
  const startBtn = document.getElementById('startPoll');
  const stopBtn = document.getElementById('stopPoll');
  const pollIntervalInput = document.getElementById('pollInterval');
  const maxAnalyzeInput = document.getElementById('maxAnalyze');
  const batchSizeInput = document.getElementById('batchSize');
  const batchDelayInput = document.getElementById('batchDelay');
  const analyzeBtn = document.getElementById('analyze');
  const statusEl = document.getElementById('status');
  const pairsTbody = document.querySelector('#pairsTable tbody');
  const topTbody = document.querySelector('#topTable tbody');
  const soundToggle = document.getElementById('soundToggle');
  const autoAnalyzeToggle = document.getElementById('autoAnalyzeToggle');
  const stopAtrMultInput = document.getElementById('stopAtrMult');
  const tp1AtrMultInput = document.getElementById('tp1AtrMult');
  const tp2AtrMultInput = document.getElementById('tp2AtrMult');
  const crossWindowInput = document.getElementById('crossWindow');

  function setStatus(s){ statusEl.textContent = s; }

  let pollTimer = null;
  let latestTickers = [];

  async function safeFetch(url, params = null) {
    const p = params ? '?' + new URLSearchParams(params).toString() : '';
    const res = await fetch(url + p);
    if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + res.statusText);
    return res.json();
  }

  function filterTickers(allTickers) {
    return allTickers
      .filter(t => t.symbol && t.symbol.endsWith('USDT') && !blacklist.includes(t.symbol))
      .map(t => ({
        symbol: t.symbol,
        lastPrice: Number(t.lastPrice),
        priceChangePercent: Number(t.priceChangePercent),
        quoteVolume: Number(t.quoteVolume)
      }))
      .sort((a,b) => (b.quoteVolume || 0) - (a.quoteVolume || 0));
  }

  function renderPairs(list){
    pairsTbody.innerHTML = '';
    list.forEach(item => {
      const tr = document.createElement('tr');
      const cls = item.priceChangePercent > 0 ? 'green' : (item.priceChangePercent < 0 ? 'red' : 'small');
      tr.innerHTML = `
        <td><strong>${item.symbol}</strong></td>
        <td class="num">${item.lastPrice.toLocaleString(undefined,{maximumFractionDigits:8})}</td>
        <td class="${cls}">${item.priceChangePercent.toFixed(2)}%</td>
        <td class="small">${Number(item.quoteVolume).toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td class="small" id="cross-${item.symbol}">—</td>
      `;
      pairsTbody.appendChild(tr);
    });
  }

  function renderTop(results){
    topTbody.innerHTML = '';
    results.forEach(r=>{
      const tr = document.createElement('tr');
      const crossText = r.crossType === 'BULL' ? 'EMA70>EMA200 (bull)' : 'EMA70<EMA200 (bear)';
      const crossCls = r.crossType === 'BULL' ? 'green' : 'red';
      const dirCls = r.direction === 'LONG' ? 'green' : 'red';
      tr.innerHTML = `
        <td><strong>${r.symbol}</strong></td>
        <td class="${crossCls}">${crossText}</td>
        <td class="${dirCls}">${r.direction}</td>
        <td class="num">${r.entry.toFixed(r.prec)}</td>
        <td class="num">${r.stop.toFixed(r.prec)}</td>
        <td class="num">${r.tp1.toFixed(r.prec)}</td>
        <td class="num">${r.tp2.toFixed(r.prec)}</td>
        <td class="num">${r.rr1.toFixed(2)}</td>
        <td class="num">${r.rr2.toFixed(2)}</td>
      `;
      topTbody.appendChild(tr);
    });
  }

  function emaSeries(values, period){
    if (values.length < period) return null;
    const k = 2 / (period + 1);
    const out = new Array(values.length).fill(null);
    let sma = values.slice(0, period).reduce((a,b)=>a+b,0)/period;
    out[period-1] = sma;
    let prev = sma;
    for (let i = period; i < values.length; i++) {
      const cur = values[i] * k + prev * (1 - k);
      out[i] = cur;
      prev = cur;
    }
    return out;
  }

  function computeATR(klines, period = 14){
    if (!klines || klines.length < period + 1) return null;
    const trs = [];
    for (let i = 1; i < klines.length; i++) {
      const hi = klines[i].h;
      const lo = klines[i].l;
      const prevC = klines[i-1].c;
      const tr = Math.max(hi - lo, Math.abs(hi - prevC), Math.abs(lo - prevC));
      trs.push(tr);
    }
    const slice = trs.slice(-period);
    const atr = slice.reduce((a,b)=>a+b,0)/slice.length;
    return atr;
  }

  // Detect recent EMA70/EMA200 cross within crossWindow candles
  function checkEMACross(klines, crossWindow = 3) {
    if (!klines || klines.length < 210) return { ok:false };
    const closes = klines.map(k=>k.c);
    const ema70 = emaSeries(closes, 70);
    const ema200 = emaSeries(closes, 200);
    if (!ema70 || !ema200) return { ok:false };

    const diff = [];
    const n = ema70.length;
    for (let i = n - (crossWindow + 1); i < n; i++) {
      if (i >= 0) diff.push(ema70[i] - ema200[i]);
    }
    if (diff.length < 2) return { ok:false };

    let crossType = null;
    let crossIndexFromEnd = null;
    for (let j = 1; j < diff.length; j++) {
      const prev = diff[j-1];
      const cur = diff[j];
      if (prev <= 0 && cur > 0) {
        crossType = 'BULL';
        crossIndexFromEnd = diff.length - 1 - j;
        break;
      }
      if (prev >= 0 && cur < 0) {
        crossType = 'BEAR';
        crossIndexFromEnd = diff.length - 1 - j;
        break;
      }
    }

    const lastIdx = closes.length - 1;
    const lastClose = closes[lastIdx];
    const lastHigh = klines[lastIdx].h;
    const lastLow = klines[lastIdx].l;

    return {
      ok: true,
      ema70Series: ema70,
      ema200Series: ema200,
      crossType,
      crossIndexFromEnd,
      lastClose,
      lastHigh,
      lastLow,
      closes,
      highs: klines.map(k=>k.h),
      lows: klines.map(k=>k.l)
    };
  }

  async function fetchKlines(symbol, interval=INTERVAL, limit=LOOKBACK_EMA200) {
    const params = { symbol, interval, limit };
    const data = await safeFetch(KLINES, params);
    return data.map(k => ({
      t: k[0],
      o: parseFloat(k[1]),
      h: parseFloat(k[2]),
      l: parseFloat(k[3]),
      c: parseFloat(k[4]),
      v: parseFloat(k[5])
    }));
  }

  async function batchAnalyzeCross(symbols, batchSize=5, batchDelay=1200) {
    const results = [];
    const crossWindow = Math.max(1, Number(crossWindowInput.value) || 3);
    for (let i=0;i<symbols.length;i+=batchSize) {
      const batch = symbols.slice(i, i+batchSize);
      setStatus(`analyzing cross batch ${Math.floor(i/batchSize)+1} / ${Math.ceil(symbols.length/batchSize)}`);
      const promises = batch.map(async sym => {
        try {
          const kl = await fetchKlines(sym, INTERVAL, LOOKBACK_EMA200);
          const chk = checkEMACross(kl, crossWindow);
          return { sym, chk, kl };
        } catch (e) {
          return { sym, error: e.message || String(e) };
        }
      });
      const resolved = await Promise.all(promises);
      results.push(...resolved);
      if (i + batchSize < symbols.length) {
        await new Promise(r => setTimeout(r, batchDelay));
      }
    }
    setStatus('EMA cross analysis complete');
    return results;
  }

  // Audio helpers
  let audioCtx = null;
  let audioUnlocked = false;
  function ensureAudioContext() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().then(()=>{ audioUnlocked = true }).catch(()=>{ audioUnlocked=false; });
    } else audioUnlocked = true;
  }
  function playBeep(freq=880, duration=120, volume=0.12, type='sine') {
    if (!audioCtx) try{ ensureAudioContext(); } catch(e){ return; }
    if (!audioUnlocked) return;
    try {
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(volume, now);
      g.gain.linearRampToValueAtTime(volume, now + 0.01);
      g.gain.linearRampToValueAtTime(0.0001, now + duration/1000);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(now); o.stop(now + duration/1000 + 0.02);
    } catch(e){}
  }
  function playNotification(){ if (!soundToggle.checked) return; playBeep(1046,80,0.08); setTimeout(()=>playBeep(1318,70,0.07),120); setTimeout(()=>playBeep(1568,60,0.06),220); }

  function buildTradeSetupByCross(sym, chk, klines){
    if (!chk || !chk.ok || !chk.crossType) return null;
    const atr = computeATR(klines.slice(-40), 14) || computeATR(klines, 14) || 0;
    const stopAtrMult = Math.max(0.1, Number(stopAtrMultInput.value) || 0.8);
    const tp1AtrMult = Math.max(0.1, Number(tp1AtrMultInput.value) || 1.5);
    const tp2AtrMult = Math.max(0.1, Number(tp2AtrMultInput.value) || 3.0);
    const lastClose = chk.lastClose;
    const lastLow = chk.lastLow;
    const lastHigh = chk.lastHigh;
    let prec = 4;
    if (lastClose >= 100) prec = 2; else if (lastClose >= 10) prec = 3; else if (lastClose < 1) prec = 6;
    const direction = chk.crossType === 'BULL' ? 'LONG' : 'SHORT';
    const entry = lastClose;
    let stop;
    if (direction === 'LONG') {
      const ema200Latest = chk.ema200Series ? chk.ema200Series[chk.ema200Series.length -1] : null;
      stop = Math.min(lastLow - atr * stopAtrMult, (ema200Latest ? ema200Latest - atr * 0.25 : lastLow - atr*stopAtrMult));
      if (stop >= entry) stop = entry - Math.max(atr * 0.2, (entry * 0.0005));
    } else {
      const ema200Latest = chk.ema200Series ? chk.ema200Series[chk.ema200Series.length -1] : null;
      stop = Math.max(lastHigh + atr * stopAtrMult, (ema200Latest ? ema200Latest + atr * 0.25 : lastHigh + atr*stopAtrMult));
      if (stop <= entry) stop = entry + Math.max(atr * 0.2, (entry * 0.0005));
    }
    let tp1,tp2;
    if (direction === 'LONG') { tp1 = entry + atr * tp1AtrMult; tp2 = entry + atr * tp2AtrMult; }
    else { tp1 = entry - atr * tp1AtrMult; tp2 = entry - atr * tp2AtrMult; }
    const risk = Math.abs(entry - stop);
    const rr1 = risk > 0 ? Math.abs(tp1 - entry) / risk : 0;
    const rr2 = risk > 0 ? Math.abs(tp2 - entry) / risk : 0;
    return { symbol: sym, direction, entry, stop, tp1, tp2, rr1, rr2, atr, prec };
  }

  async function handleCrossResultsAndPlaySound(results){
    const detected = [];
    results.forEach(r=>{
      const id = 'cross-' + r.sym;
      const cell = document.getElementById(id);
      if (cell) {
        if (r.chk && r.chk.ok && r.chk.crossType) {
          const txt = r.chk.crossType === 'BULL' ? '70→200 (bull)' : '70→200 (bear)';
          cell.textContent = txt;
          cell.classList.remove('green','red');
          cell.classList.add(r.chk.crossType === 'BULL' ? 'green' : 'red');
        } else {
          cell.textContent = '—';
          cell.classList.remove('green','red');
        }
      }
      if (r.chk && r.chk.ok && r.chk.crossType) {
        const setup = buildTradeSetupByCross(r.sym, r.chk, r.kl || []);
        if (setup) {
          detected.push({
            symbol: r.sym,
            crossType: r.chk.crossType,
            crossIndexFromEnd: r.chk.crossIndexFromEnd,
            closePct: Math.abs(r.chk.lastClose - (r.chk.ema200Series ? r.chk.ema200Series[r.chk.ema200Series.length-1] : r.chk.lastClose))/ (r.chk.ema200Series ? r.chk.ema200Series[r.chk.ema200Series.length-1] : r.chk.lastClose) * 100,
            ...setup
          });
        }
      }
    });

    if (soundToggle.checked && detected.length > 0) {
      playNotification();
      let delay=360;
      detected.slice(0,10).forEach(d=>{
        setTimeout(()=>{ if (d.crossType==='BULL') playBeep(1400,90,0.09); else playBeep(900,120,0.11); }, delay);
        delay+=140;
      });
    }

    // sort: most recent cross (smaller crossIndexFromEnd) first, then rr1 desc
    detected.sort((a,b)=>{
      const ai = (a.crossIndexFromEnd == null) ? 9999 : a.crossIndexFromEnd;
      const bi = (b.crossIndexFromEnd == null) ? 9999 : b.crossIndexFromEnd;
      if (ai !== bi) return ai - bi;
      if ((b.rr1 || 0) !== (a.rr1 || 0)) return (b.rr1 || 0) - (a.rr1 || 0);
      return Math.abs(b.closePct || 0) - Math.abs(a.closePct || 0);
    });

    renderTop(detected.slice(0,50));
    setStatus(`EMA cross analysis finished. ${detected.length} symbols with cross setups`);
  }

  async function pollTickersOnce(){
    try {
      const raw = await safeFetch(TICKER_24H);
      const filtered = filterTickers(raw);
      latestTickers = filtered;
      renderPairs(filtered.slice(0,500));
      setStatus(`polled ${raw.length} tickers, ${filtered.length} USDT perpetuals (blacklist removed)`);

      if (autoAnalyzeToggle.checked) {
        ensureAudioContext();
        const maxAnalyze = Math.max(1, Number(maxAnalyzeInput.value) || 20);
        const batchSize = Math.max(1, Number(batchSizeInput.value) || 5);
        const batchDelay = Math.max(300, Number(batchDelayInput.value) || 1200);
        const toAnalyze = latestTickers.slice(0, maxAnalyze).map(t => t.symbol);
        setStatus(`(auto) starting EMA cross analysis for ${toAnalyze.length} symbols...`);
        const results = await batchAnalyzeCross(toAnalyze, batchSize, batchDelay);
        await handleCrossResultsAndPlaySound(results);
      }
    } catch(e){
      setStatus('poll error: ' + e.message);
      console.error(e);
    }
  }

  startBtn.onclick = ()=>{
    const interval = Math.max(5, Number(pollIntervalInput.value) || 10);
    if (pollTimer) clearInterval(pollTimer);
    ensureAudioContext();
    pollTickersOnce();
    pollTimer = setInterval(pollTickersOnce, interval * 1000);
    startBtn.disabled = true; stopBtn.disabled = false;
    setStatus('polling started');
  };
  stopBtn.onclick = ()=>{
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    startBtn.disabled = false; stopBtn.disabled = true; setStatus('polling stopped');
  };

  analyzeBtn.onclick = async ()=>{
    if (!latestTickers || latestTickers.length === 0) { setStatus('no symbols to analyze - run poll first'); return; }
    ensureAudioContext();
    const maxAnalyze = Math.max(1, Number(maxAnalyzeInput.value) || 20);
    const batchSize = Math.max(1, Number(batchSizeInput.value) || 5);
    const batchDelay = Math.max(300, Number(batchDelayInput.value) || 1200);
    const toAnalyze = latestTickers.slice(0, maxAnalyze).map(t => t.symbol);
    setStatus(`starting EMA cross analysis for ${toAnalyze.length} symbols (batch ${batchSize}, delay ${batchDelay}ms).`);
    const results = await batchAnalyzeCross(toAnalyze, batchSize, batchDelay);
    await handleCrossResultsAndPlaySound(results);
  };

  setStatus('idle — click "Start Live Polling"');

  // optional auto-start
  // startBtn.click();
  </script>
</body>
</html>
