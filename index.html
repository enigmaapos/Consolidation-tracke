<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binance Futures — EMA200 Touch (Responsive)</title>
  <style>
    /* Mobile-first, accessible, responsive card layout */
    :root{
      --bg:#0f1720; --muted:#94a3b8; --accent:#06b6d4; --card:#071624; --card-2:#0b1220; --success:#10b981; --danger:#fb7185; --glass:rgba(255,255,255,0.03);
    }
    html,body{height:100%; margin:0; font-family:Inter, Roboto, system-ui, -apple-system,Segoe UI, Arial; background:linear-gradient(180deg,#071022 0%,var(--bg) 100%); color:#e6eef8;}
    .app{max-width:1200px; margin:16px auto; padding:16px; box-sizing:border-box;}

    header{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    p.lead{margin:6px 0 0 0; color:var(--muted); font-size:13px}

    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px}
    .control{display:flex; gap:6px; align-items:center; background:var(--card); padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,0.03)}
    .control input[type=number]{width:78px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
    button{background:var(--accent); color:#042024; border:0; padding:8px 12px; border-radius:9px; cursor:pointer; font-weight:600}
    button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04)}

    .status{margin-left:8px;color:var(--muted); font-size:13px}

    /* layout: cards grid */
    .grid{display:grid; gap:12px; margin-top:18px}
    /* 1 column on phones, 2 on small tablets, 3 on desktop, 4 on wide */
    @media (min-width:480px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (min-width:820px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (min-width:1100px){ .grid{grid-template-columns:repeat(4,1fr);} }

    .card{background:linear-gradient(180deg,var(--card),var(--card-2)); padding:12px; border-radius:12px; border:1px solid var(--glass); box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .card .top{display:flex; justify-content:space-between; align-items:center; gap:8px}
    .symbol{font-weight:700; font-size:15px}
    .price{font-variant-numeric:tabular-nums; color:var(--muted); font-size:13px}
    .badge{padding:6px 8px; border-radius:999px; font-size:12px; background:rgba(255,255,255,0.02); color:var(--muted)}

    .metrics{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .metric{flex:1 1 48%; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; font-size:13px}
    .metric strong{display:block; font-size:12px; color:var(--muted)}

    .touch{display:inline-flex; gap:8px; align-items:center; margin-top:12px}
    .touch .ok{color:var(--success); font-weight:700}
    .touch .near{color:var(--accent); font-weight:700}
    .touch .no{color:var(--muted)}

    /* table fallback (desktop wide) */
    .tableWrap{margin-top:18px; display:none}
    @media (min-width:1100px){ .tableWrap{display:block} .grid{display:none} }
    table{width:100%; border-collapse:collapse; background:transparent}
    th,td{padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px}
    th{color:var(--muted); font-size:12px}

    footer{margin-top:18px; color:var(--muted); font-size:13px}

    /* small helpers */
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .flexRow{display:flex; gap:8px; align-items:center}

    /* accessible focus states */
    button:focus, input:focus{outline:2px solid rgba(6,182,212,0.18); outline-offset:2px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Binance Futures — EMA200 Touch</h1>
        <p class="lead">Responsive, mobile-first UI that highlights symbols near or touching the EMA200 (15m interval). Removed the previous consolidation module for clarity.</p>
      </div>
      <div class="flexRow" aria-hidden="false">
        <div class="control" role="group" aria-label="poll settings">
          <label class="small muted">Poll (s)</label>
          <input id="pollInterval" type="number" min="5" value="10" aria-label="poll interval in seconds">
        </div>
        <div class="control" role="group" aria-label="analysis settings">
          <label class="small muted">Max symbols</label>
          <input id="maxAnalyze" type="number" min="1" value="20" aria-label="maximum symbols to analyze">
        </div>
      </div>
    </header>

    <div class="controls">
      <button id="startPoll">Start Live Polling</button>
      <button id="stopPoll" class="ghost" disabled>Stop</button>
      <button id="checkNow" class="ghost">Check EMA200 Now</button>
      <div class="status" id="status">idle</div>
    </div>

    <!-- Cards grid for results (mobile-first) -->
    <div class="grid" id="cardsGrid" aria-live="polite" aria-label="symbols near EMA200"></div>

    <!-- Table fallback for wide screens -->
    <div class="tableWrap">
      <div class="muted">Results table (desktop)</div>
      <table id="resultsTable" role="table" aria-label="results table">
        <thead>
          <tr><th>Symbol</th><th>Last</th><th>24h %</th><th>EMA200</th><th>Proximity</th><th>Touch</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      <div class="muted">Notes: EMA200 uses 220 candles (15m). Keep max symbols small to avoid rate limits. This tool only detects EMA200 wick crosses and close proximity; it is for scanning purposes and not trading advice.</div>
    </footer>
  </div>

  <script>
    // --- Config ---
    const TICKER_24H = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
    const KLINES = 'https://fapi.binance.com/fapi/v1/klines';
    const INTERVAL = '15m';
    const LOOKBACK_EMA200 = 220; // >=200 candles for EMA200
    const EMA200_TOL_PCT = 0.05; // 0.05% proximity

    const blacklist = [
      "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT","LINAUSDT",
      "LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT",
      "STMXUSDT","UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT",
      "BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT",
      "STRAXUSDT","COMBOUSDT","AI16ZUSDT"
    ];

    // UI refs
    const startBtn = document.getElementById('startPoll');
    const stopBtn = document.getElementById('stopPoll');
    const checkBtn = document.getElementById('checkNow');
    const pollIntervalInput = document.getElementById('pollInterval');
    const maxAnalyzeInput = document.getElementById('maxAnalyze');
    const statusEl = document.getElementById('status');
    const cardsGrid = document.getElementById('cardsGrid');
    const resultsTableBody = document.querySelector('#resultsTable tbody');

    let pollTimer = null;
    let latestTickers = [];

    function setStatus(txt){ statusEl.textContent = txt; }

    async function safeFetch(url, params=null){
      const p = params ? '?' + new URLSearchParams(params).toString() : '';
      const res = await fetch(url + p);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    function filterTickers(all){
      return all
        .filter(t => t.symbol && t.symbol.endsWith('USDT') && !blacklist.includes(t.symbol))
        .map(t=>({ symbol: t.symbol, lastPrice: Number(t.lastPrice), priceChangePercent: Number(t.priceChangePercent), quoteVolume: Number(t.quoteVolume) }))
        .filter(t=> Math.abs(t.priceChangePercent) <= 15 )
        .sort((a,b)=>Math.abs(b.priceChangePercent) - Math.abs(a.priceChangePercent));
    }

    // EMA helper (returns last ema value)
    function emaSeries(values, period){
      if(values.length < period) return null;
      const k = 2/(period+1);
      const out = new Array(values.length).fill(null);
      let sma = values.slice(0,period).reduce((a,b)=>a+b,0)/period;
      out[period-1] = sma; let prev = sma;
      for(let i=period;i<values.length;i++){ const v = values[i]; const cur = v * k + prev * (1-k); out[i] = cur; prev = cur; }
      return out;
    }

    function checkEMA200Touch(fullKlines){
      if(!fullKlines || fullKlines.length < 200) return { ok:false };
      const closes = fullKlines.map(k=>k.c);
      const highs = fullKlines.map(k=>k.h);
      const lows = fullKlines.map(k=>k.l);
      const ema200Series = emaSeries(closes, 200);
      if(!ema200Series) return { ok:false };
      const ema200 = ema200Series[ema200Series.length-1];
      const lastH = highs[highs.length-1];
      const lastL = lows[lows.length-1];
      const lastC = closes[closes.length-1];
      const strictTouch = (lastH >= ema200 && lastL <= ema200);
      const closeProximityPct = Math.abs(lastC - ema200)/ema200*100;
      const closeNear = closeProximityPct <= EMA200_TOL_PCT;
      return { ok:true, ema200, strictTouch, closeNear, closeProximityPct };
    }

    async function fetchKlines(symbol, interval=INTERVAL, limit=LOOKBACK_EMA200){
      const params = { symbol, interval, limit };
      const data = await safeFetch(KLINES, params);
      return data.map(k=>({ t:k[0], o:parseFloat(k[1]), h:parseFloat(k[2]), l:parseFloat(k[3]), c:parseFloat(k[4]), v:parseFloat(k[5]) }));
    }

    // Batch check only EMA200 touch (no consolidation)
    async function batchCheck(symbols, batchSize=5, batchDelay=800){
      const out = [];
      for(let i=0;i<symbols.length;i+=batchSize){
        const batch = symbols.slice(i, i+batchSize);
        setStatus(`checking batch ${Math.floor(i/batchSize)+1}/${Math.ceil(symbols.length/batchSize)}`);
        const promises = batch.map(async sym=>{
          try{
            const kl = await fetchKlines(sym);
            const chk = checkEMA200Touch(kl);
            return { sym, chk, lastPrice: kl[kl.length-1].c };
          }catch(e){ return { sym, error: e.message || String(e) } }
        });
        const res = await Promise.all(promises);
        out.push(...res);
        if(i + batchSize < symbols.length) await new Promise(r=>setTimeout(r, batchDelay));
      }
      setStatus('check complete');
      return out;
    }

    // Render results as cards (mobile) and table (desktop)
    function renderResults(results, tickersMap){
      cardsGrid.innerHTML = '';
      results.forEach(r=>{
        const meta = tickersMap[r.sym] || {};
        const card = document.createElement('article'); card.className = 'card';
        const touchText = r.chk && r.chk.ok ? (r.chk.strictTouch ? '<span class="ok">Wick cross</span>' : (r.chk.closeNear ? `<span class="near">Close ~${r.chk.closeProximityPct.toFixed(3)}%</span>` : '<span class="no">No</span>')) : '<span class="muted small">n/a</span>';
        card.innerHTML = `
          <div class="top">
            <div>
              <div class="symbol">${r.sym}</div>
              <div class="price small">${meta.lastPrice !== undefined ? Number(meta.lastPrice).toLocaleString(undefined,{maximumFractionDigits:8}) : (r.lastPrice ? Number(r.lastPrice).toLocaleString(undefined,{maximumFractionDigits:8}) : '—')}</div>
            </div>
            <div class="badge small">${meta.priceChangePercent !== undefined ? (meta.priceChangePercent.toFixed(2) + '%') : ''}</div>
          </div>
          <div class="metrics">
            <div class="metric"><strong class="muted">EMA200</strong><span>${r.chk && r.chk.ok ? Number(r.chk.ema200).toFixed(6) : 'n/a'}</span></div>
            <div class="metric"><strong class="muted">Proximity</strong><span>${r.chk && r.chk.ok ? (r.chk.closeProximityPct.toFixed(4) + '%') : 'n/a'}</span></div>
          </div>
          <div class="touch">${touchText}</div>
        `;
        cardsGrid.appendChild(card);
      });

      // table (desktop)
      resultsTableBody.innerHTML = '';
      results.forEach(r=>{
        const meta = tickersMap[r.sym] || {};
        const tr = document.createElement('tr');
        const proximity = r.chk && r.chk.ok ? (r.chk.closeProximityPct.toFixed(4) + '%') : 'n/a';
        const touch = r.chk && r.chk.ok ? (r.chk.strictTouch ? 'wick-cross' : (r.chk.closeNear ? `close~${r.chk.closeProximityPct.toFixed(3)}%` : 'no')) : 'n/a';
        tr.innerHTML = `<td>${r.sym}</td><td>${meta.lastPrice !== undefined ? Number(meta.lastPrice).toLocaleString(undefined,{maximumFractionDigits:8}) : (r.lastPrice?Number(r.lastPrice).toLocaleString(): '—')}</td><td class="small muted">${meta.priceChangePercent!==undefined?meta.priceChangePercent.toFixed(2)+'%':''}</td><td>${r.chk && r.chk.ok?Number(r.chk.ema200).toFixed(6):'n/a'}</td><td>${proximity}</td><td>${touch}</td>`;
        resultsTableBody.appendChild(tr);
      });
    }

    // Poll tickers once (24h) and cache
    async function pollTickersOnce(){
      try{
        const raw = await safeFetch(TICKER_24H);
        const filtered = filterTickers(raw);
        latestTickers = filtered;
        setStatus(`polled ${raw.length} tickers, ${filtered.length} matched`);
      }catch(e){ setStatus('poll error: ' + (e.message||e)); console.error(e); }
    }

    // Controls
    startBtn.onclick = () => {
      const interval = Math.max(5, Number(pollIntervalInput.value) || 10);
      if(pollTimer) clearInterval(pollTimer);
      pollTickersOnce();
      pollTimer = setInterval(pollTickersOnce, interval*1000);
      startBtn.disabled = true; stopBtn.disabled = false; setStatus('polling started');
    };
    stopBtn.onclick = () => { if(pollTimer){ clearInterval(pollTimer); pollTimer=null;} startBtn.disabled=false; stopBtn.disabled=true; setStatus('polling stopped'); };

    // Manual check button — takes top N from cached tickers and runs EMA200 check only
    checkBtn.onclick = async () => {
      if(!latestTickers || latestTickers.length===0){ setStatus('no tickers cached — start polling first'); return; }
      const maxAnalyze = Math.max(1, Number(maxAnalyzeInput.value) || 20);
      const toAnalyze = latestTickers.slice(0, maxAnalyze).map(t=>t.symbol);
      // create map of meta for rendering
      const tickersMap = Object.fromEntries(latestTickers.slice(0, maxAnalyze).map(t=>[t.symbol, t]));
      setStatus(`checking ${toAnalyze.length} symbols for EMA200`);
      try{
        const results = await batchCheck(toAnalyze, 4, 900);
        renderResults(results, tickersMap);
        const hits = results.filter(r=>r.chk && r.chk.ok && (r.chk.strictTouch || r.chk.closeNear)).length;
        setStatus(`done — ${hits} near/touch EMA200`);
      }catch(e){ setStatus('check error: ' + (e.message||e)); console.error(e); }
    };

    // init state
    setStatus('idle — click Start Live Polling');
  </script>
</body>
</html>
