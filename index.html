<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>EMA200 Consolidation Scanner â€” Binance Futures</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  body{
    font-family: Inter, system-ui, Arial;
    background:#0f1720;
    color:#e6eef8;
    margin:16px;
  }
  h1{font-size:18px;margin-bottom:6px}
  .status{color:#9fb3cc;font-size:13px;margin-bottom:10px}
  button{
    padding:8px 12px;
    background:#22c55e;
    color:#052e16;
    border:0;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:12px;
    margin-top:12px;
  }
  .card{
    background:#0b1220;
    border:1px solid #172033;
    border-radius:10px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.5);
  }
  .symbol{font-weight:700;font-size:15px}
  .muted{color:#9fb3cc;font-size:13px}
  .good{color:#22c55e}
</style>
</head>

<body>

<h1>ðŸ“Š EMA200 Consolidation Scanner (15m)</h1>
<div class="status" id="status">Idle</div>
<button onclick="runScan()">Run Scan</button>

<div class="grid" id="results"></div>

<script>
/* ================= CONFIG ================= */
const API = 'https://fapi.binance.com';
const TOP_N = 30;
const TF = '15m';
const EMA_LEN = 200;
const CONSOL_CANDLES = 8;
const MAX_RANGE_PCT = 1.2;      // consolidation range %
const EMA_DISTANCE_PCT = 0.8;   // distance from EMA200 %
const FETCH_DELAY_MS = 550;     // rate-limit safety
const AUTO_REFRESH_MS = 5 * 60 * 1000;
/* ========================================== */

/* ---------- BLACKLIST ---------- */
const BLACKLIST = new Set([
  "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT","LINAUSDT",
  "LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT",
  "STMXUSDT","UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT",
  "BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT",
  "STRAXUSDT","COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
  "MYROUSDT","1000XUSDT","DARUSDT"
]);

/* ---------- helpers ---------- */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const elResults = document.getElementById('results');
const elStatus  = document.getElementById('status');

/* ---------- EMA ---------- */
function ema(values, len){
  const k = 2 / (len + 1);
  let e = values[0];
  for(let i=1;i<values.length;i++){
    e = values[i] * k + e * (1-k);
  }
  return e;
}

/* ---------- Consolidation detector ---------- */
function isConsolidating(klines){
  const slice = klines.slice(-CONSOL_CANDLES);
  const highs = slice.map(k=>+k[2]);
  const lows  = slice.map(k=>+k[3]);
  const closes= slice.map(k=>+k[4]);

  const maxH = Math.max(...highs);
  const minL = Math.min(...lows);
  const rangePct = ((maxH - minL) / closes[closes.length-1]) * 100;

  const ema200 = ema(
    klines.map(k=>+k[4]).slice(-EMA_LEN),
    EMA_LEN
  );

  const lastClose = closes[closes.length-1];
  const emaDistPct = Math.abs(lastClose - ema200) / ema200 * 100;

  return rangePct <= MAX_RANGE_PCT &&
         emaDistPct <= EMA_DISTANCE_PCT;
}

/* ---------- Core Scan ---------- */
async function runScan(){
  elResults.innerHTML = '';
  elStatus.textContent = 'Fetching top green pairsâ€¦';

  let tickers;
  try{
    tickers = await fetch(API + '/fapi/v1/ticker/24hr').then(r=>r.json());
  }catch(e){
    elStatus.textContent = 'Failed to fetch tickers';
    return;
  }

  const topGreen = tickers
    .filter(t =>
      t.symbol.endsWith('USDT') &&
      +t.priceChangePercent > 0 &&
      !BLACKLIST.has(t.symbol)
    )
    .sort((a,b)=>b.priceChangePercent - a.priceChangePercent)
    .slice(0, TOP_N);

  let found = 0;

  for(const t of topGreen){
    elStatus.textContent = `Scanning ${t.symbol}â€¦`;
    try{
      const klines = await fetch(
        `${API}/fapi/v1/klines?symbol=${t.symbol}&interval=${TF}&limit=210`
      ).then(r=>r.json());

      if(klines.length < EMA_LEN) continue;

      if(isConsolidating(klines)){
        found++;
        const last = klines[klines.length-1];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="symbol good">${t.symbol}</div>
          <div class="muted">15m consolidation near EMA200</div>
          <div class="muted">Last Price: ${(+last[4]).toFixed(6)}</div>
          <div class="muted">24h Change: ${(+t.priceChangePercent).toFixed(2)}%</div>
        `;
        elResults.appendChild(card);
      }
    }catch(e){}
    await sleep(FETCH_DELAY_MS);
  }

  elStatus.textContent =
    `Done â€¢ ${found} matches â€¢ Updated ${new Date().toLocaleString()}`;
}

/* ---------- Auto Refresh ---------- */
runScan();
setInterval(runScan, AUTO_REFRESH_MS);
</script>

</body>
</html>
