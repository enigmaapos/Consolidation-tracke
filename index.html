<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>EMA14 & EMA21 Touch & Distance Scanner â€” Binance Futures</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  body{
    font-family: Inter, system-ui, Arial;
    background:#0f1720;
    color:#e6eef8;
    margin:16px;
  }
  h1{font-size:18px;margin-bottom:6px}
  .status{color:#9fb3cc;font-size:13px;margin-bottom:10px}
  button{
    padding:8px 12px;
    background:#22c55e;
    color:#052e16;
    border:0;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:12px;
    margin-top:12px;
  }
  .card{
    background:#0b1220;
    border:1px solid #172033;
    border-radius:10px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.5);
  }
  .symbol{font-weight:700;font-size:15px}
  .muted{color:#9fb3cc;font-size:13px}
  .good{color:#22c55e}
  .warn{color:#fbbf24}
</style>
</head>

<body>

<h1>ðŸ“Š EMA14 & EMA21 Touch â†’ Distance Scanner (15m)</h1>
<div class="status" id="status">Idle</div>
<button onclick="runScan()">Run Scan</button>

<div class="grid" id="results"></div>

<script>
/* ================= CONFIG ================= */
const API = 'https://fapi.binance.com';
const TOP_N = 30;
const TF = '15m';
const EMA_FAST = 14;
const EMA_SLOW = 21;
const LOOKBACK_CANDLES = 96; // last 24h
const FETCH_DELAY_MS = 550;
const AUTO_REFRESH_MS = 5 * 60 * 1000;
/* ========================================== */

/* ---------- BLACKLIST ---------- */
const BLACKLIST = new Set([
  "ALPACAUSDT","BNXUSDT","ALPHAUSDT","OCEANUSDT","DGBUSDT","AGIXUSDT","LINAUSDT",
  "LOKAUSDT","KEYUSDT","MDTUSDT","LOOMUSDT","RENUSDT","OMNIUSDT","SLERFUSDT",
  "STMXUSDT","UXLINKUSDT","BSWUSDT","NEIROETHUSDT","VIDTUSDT","TROYUSDT",
  "BAKEUSDT","AMBUSDT","MEMEFIUSDT","NULSUSDT","HIFIUSDT","LEVERUSDT","XEMUSDT",
  "STRAXUSDT","COMBOUSDT","AI16ZUSDT","MILKUSDT","TOKENUSDT","SXPUSDT",
  "MYROUSDT","1000XUSDT","DARUSDT"
]);

/* ---------- helpers ---------- */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const elResults = document.getElementById('results');
const elStatus  = document.getElementById('status');

/* ---------- EMA ---------- */
function ema(values, len){
  const k = 2 / (len + 1);
  let e = values[0];
  for(let i=1;i<values.length;i++){
    e = values[i] * k + e * (1-k);
  }
  return e;
}

/* ---------- EMA14 / EMA21 analysis ---------- */
function analyzeEMA14_21(klines){
  const closes = klines.map(k=>+k[4]);

  const ema14 = ema(closes.slice(-EMA_FAST), EMA_FAST);
  const ema21 = ema(closes.slice(-EMA_SLOW), EMA_SLOW);

  const recent = klines.slice(-LOOKBACK_CANDLES);

  const touched = recent.some(k=>{
    const high = +k[2];
    const low  = +k[3];
    return (
      (low <= ema14 && high >= ema14) ||
      (low <= ema21 && high >= ema21)
    );
  });

  const lastClose = closes[closes.length - 1];
  const aboveNow = lastClose > ema21;

  const nearestEMA =
    Math.abs(lastClose - ema14) < Math.abs(lastClose - ema21)
      ? ema14
      : ema21;

  const distancePct = Math.abs(lastClose - nearestEMA) / nearestEMA * 100;

  return {
    touched,
    aboveNow,
    lastClose,
    distancePct,
    ema14,
    ema21
  };
}

/* ---------- Core Scan ---------- */
async function runScan(){
  elResults.innerHTML = '';
  elStatus.textContent = 'Fetching top green pairsâ€¦';

  let tickers;
  try{
    tickers = await fetch(API + '/fapi/v1/ticker/24hr').then(r=>r.json());
  }catch{
    elStatus.textContent = 'Failed to fetch tickers';
    return;
  }

  const universe = tickers
    .filter(t =>
      t.symbol.endsWith('USDT') &&
      +t.priceChangePercent > 0 &&
      !BLACKLIST.has(t.symbol)
    )
    .sort((a,b)=>b.priceChangePercent - a.priceChangePercent)
    .slice(0, TOP_N);

  const aboveEMA = [];
  const belowEMA = [];

  for(const t of universe){
    elStatus.textContent = `Scanning ${t.symbol}â€¦`;
    try{
      const klines = await fetch(
        `${API}/fapi/v1/klines?symbol=${t.symbol}&interval=${TF}&limit=300`
      ).then(r=>r.json());

      if(klines.length < EMA_SLOW) continue;

      const res = analyzeEMA14_21(klines);
      if(!res.touched) continue;

      const payload = {
        symbol: t.symbol,
        last: res.lastClose,
        distance: res.distancePct,
        change24h: +t.priceChangePercent
      };

      if(res.aboveNow) aboveEMA.push(payload);
      else belowEMA.push(payload);

    }catch{}
    await sleep(FETCH_DELAY_MS);
  }

  aboveEMA.sort((a,b)=>b.change24h - a.change24h);
belowEMA.sort((a,b)=>b.change24h - a.change24h);

  let found = 0;

  function render(item, type){
    found++;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="symbol ${type === 'above' ? 'good' : 'warn'}">
        ${item.symbol}
      </div>
      <div class="muted">
        ${type === 'above'
          ? 'Above EMA21 (Short-term trend)'
          : 'Below EMA21'}
      </div>
      <div class="muted">Last Price: ${item.last.toFixed(6)}</div>
      <div class="muted">EMA14/21 Distance: ${item.distance.toFixed(2)}%</div>
      <div class="muted">24h Change: ${item.change24h.toFixed(2)}%</div>
    `;
    elResults.appendChild(card);
  }

  aboveEMA.forEach(i => render(i,'above'));
  belowEMA.forEach(i => render(i,'below'));

  elStatus.textContent =
    `Done â€¢ ${found} matches â€¢ Updated ${new Date().toLocaleString()}`;
}

/* ---------- Auto Refresh ---------- */
runScan();
setInterval(runScan, AUTO_REFRESH_MS);
</script>

</body>
</html>
